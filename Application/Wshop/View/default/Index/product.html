
<extend name="Public/common"/>
<block name="style">
    <link rel="stylesheet" href="__CSS__/swiper/swiper.min.css">
    <link rel="stylesheet" href="__CSS__/swiper.css">
    <link rel="stylesheet" href="__CSS__/default/product.css">
    <link rel="stylesheet" href="__CSS__/count_box.css">
    <style>

    </style>
</block>
<block name="body">
<div id="main-container" class="container">
<div class="product-intro">
    <div class="preview">
    <div class="col-xs-5">
        <nav>
        <div class="nav-swiper-container">
            <div class="swiper-wrapper">
                <php>
                if(!empty($product['images'])){
                    $product['images'] = explode(',',$product['images']);
                    foreach($product['images'] as $img){
                </php>
                    <div class="swiper-slide"><img class="slide-img detail-nav-scale" src="<php> echo pic($img) </php>"></div>
                <php>
                    }
                }else{
                </php>
                    <div class="swiper-slide"><img class="slide-img detail-nav-scale" src="<php> echo pic($product['main_img']) </php>"></div>
                <php>
                }
                </php>
            </div>
            <div class="swiper-count-box">
                <span class="active-index-num">1</span> / <span class="all-index-num">1</span>
            </div>
        </div>
        <div class="section-pic-tips-group">
            <php>
            $count = 0;
            $status = explode(',',$product['info']);
            array_walk($status,
            function ($a)
            {
            switch($a){
            case 6:
            echo '<p class="section-pic-tips" style="background: #fc7539;">热销</p>';
            break;
            case 7:
            echo '<p class="section-pic-tips" style="background: #7fbf23;">推荐</p>';
            break;
            }
            });
            </php>
        </div>
        </nav>
        </div>
        <div class="col-xs-7">
            <h3 class="title-section text-section big-text">{$product['title']}</h3>
            <section class="price-section">
                <span class="big-price price">
                    ￥{$product.price}
                </span>
                <span class="small-price price" style="text-decoration: line-through">
                    ￥{$product.ori_price}
                </span>

            </section>
            <php>
            /*有规格，在规格里选择数量*/
            if(!empty($product['sku_table'])){
            </php>
                <div class="quantity">剩余库存：(<span>{$product['quantity']}</span>)</div>
                <div class="sku-content">
                    <php>
                    foreach($product['sku_table']['table'] as $in => $table){
                    </php>
                        <dl class="sku-box clearfix">
                            <dt><php> echo $in </php></dt>
                            <dd>
                            <ul data-sku="<php> echo $in </php>">
                                <php>foreach($table as $t){</php>
                                    <li class="" data-table="<php> echo $in </php>" data-value="<php> echo $t </php>"><php> echo $t </php><i></i></li>
                                <php>}</php>
                            </ul>
                            </dd>
                        </dl>
                    <php>
                    }
                    </php>
                </div>
            <php>}/*没有的单独选择*/
            else{</php>
                <section class="linear-section vertical-box linear-noinput">
                    <div class="quantity">剩余库存：(<span>{$product['quantity']}</span>)</div>
                </section>
            <php>
            }
            </php>

            <php>
            if(!empty($product['extra_info'])){
                </php>
                <section class="info-section linear-section vertical-box linear-noinput">
                    <span class="linear-title vertical-box">产品参数</span>
                <span class="linear-right vertical-box">
                    <span>
                        <img class="info-icon" src="__IMG__/go.png">
                    </span>
                </span>
                </section>
                <div class="info-content last-liner-section" style="display: none;">
                    <php>
                    foreach($product['extra_info'] as $info){
                    </php>
                        <p>
                            <span class="info-ukey"><php> echo $info['ukey'] </php></span>：
                            <span class="info-data"><php> echo $info['data'] </php></span>
                        </p>
                    <php>
                    }
                    </php>
                </div>
            <php>
            }
            </php>



            <section class="">
                <div class="">
                    <php>if($product['quantity']==0){</php>
                        <button class="color-disable">已经卖光啦</button>
                    <php>
                    }else{
                    </php>
                        <button class="addCartNow sku-data btn btn-warning">加入购物车</button>
                        <button class="buyImmediately sku-data btn btn-warning">立即购买</button>
                    <php>}</php>

                </div>
            </section>
        </div>
    </div>
</div>

<div class="col-xs-12">

             <section class="linear-section last-liner-section vertical-box linear-noinput" <php>
                if($product['comment_cnt']!='0') echo 'onclick="window.location.href=\''.U('shop/index/commentlist').'&product_id='.$product['id'].'\'"'; </php> >
                <span class="linear-title vertical-box">宝贝评价（<php> echo $product['comment_cnt'] </php>）</span>
                <span class="linear-right vertical-box"><span>
                    <span class="tips-font">全部</span><img src="__IMG__/go.png">
                </span></span>
            </section>


    <article class="detail-margin">
        <div class="detail-box">
            
            <section class="detail-section ">
                <div class="html-box">
                    <php> echo $product['content'] </php>
                </div>
            </section>
            <div class="bottom-btn vertical-box"><img src="__IMG__/bottom.png"></div>
        </div>
    </article>

    <div class="detail-shadow"></div>
</div>
    
</div>

<script>
    var product_id = {$product.id};
    var product_sku = {$product_sku};
    var order_sku;//最终订单SKU
    
    //var make_order_url = '{:U('wshop/order/makeorder')}';
    $(function(){ 
        if(product_sku){
            quantity();//初始化库存数
            var sku_info = {};//规格参数
            var _li = $('.sku-content li');
            //点击事件
            $('.sku-content li').click(function(){
                var skuArr = [];
                $.each(product_sku.table, function(idx, obj) {
                    skuArr.push(idx);
                });

                var _this = $(this);
                var dataSku = _this.parent().attr('data-sku');
                
                if(_this.hasClass('no_sku')){
                    delete sku_info[_this.attr('data-table')];
                    return;
                }

                if(_li.hasClass('no_sku')){
                    delete sku_info[_this.attr('data-table')];
                }

                sku_info[_this.attr('data-table')]=_this.attr('data-value');
                _this.siblings().removeClass('selected');//同胞元素取消选择
                _this.addClass("selected");
                _li.removeClass('no_sku');

                
                //console.log(sku_info);
                //调整规格参数对象顺序
                var skuObj={};
                skuArr.forEach(function(el){
                    skuObj[el]=sku_info[el];
                });
                sku_info = skuObj;
                //console.log(skuObj);
                //拼接数据查询字符串
                var t='';
                $.each(skuObj,function(a,b){
                    if(!b){
                        b='';
                    }else{
                        t += ';'+a+':'+b;
                    }
                    //去除t最前面的分号
                    if(t.substr(0,1)==';')t=t.substr(1);
                });
                //alert(t);
                
                //遍历JSON对象
                
                $.each(product_sku.info, function(idx, obj) {
                    //把IDX拆分成数组，避免indexOf时字符串的多次包含BUG
                    var idx = idx.split(';');
                    if(idx.indexOf(_this.attr('data-table')+':'+_this.attr('data-value'))>= 0){

                        //alert(idx);
                         for(var i=0;i<_li.length;i++){
                        //     定义查询条件a   
                             var a = $(_li[i]).attr('data-table')+':'+$(_li[i]).attr('data-value');
                             if(
                                 idx.indexOf(a)>= 0 && 
                                 _this.attr('data-table')!=$(_li[i]).attr('data-table') 
                        //         _this.attr('data-value')!=$(_li[i]).attr('data-value')
                             ){
                                 if(obj.quantity=='' || obj.quantity==0){
                                     $(_li[i]).removeClass('selected');
                                     $(_li[i]).addClass('no_sku');
                                 }
                             }
                         }  
                    }
                });

                //获取读取库存参数
                var selectedLi = $('.sku-content li.selected');
                var q='';
                for(var i=0;i<selectedLi.length;i++){
                    q+=';'+$(selectedLi[i]).attr('data-table')+':'+$(selectedLi[i]).attr('data-value');
                }
                if(q.substr(0,1)==';')q=q.substr(1);
                q = quantity(q);
                //alert(q);
            })
        } 
    })

/*
获取库存数量
 */
function quantity(t){
    var q = 0;
    $.each(product_sku.info, function(idx, obj) {
        if(!t){
            q+=parseInt(obj.quantity);
        }else{
            if(t.indexOf(';')>=0){
                if(idx==t){
                    q=parseInt(obj.quantity);
                }
            }else{
                var idx = idx.split(';');
                if(idx.indexOf(t)>= 0){
                    q+=parseInt(obj.quantity);
                }
            }
        }
    })

    $('.quantity span').text(q);
    return q;
}
</script>
</block>